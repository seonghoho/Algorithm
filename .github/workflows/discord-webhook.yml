name: Send Commit Info to Discord

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract commit info and filter
        id: commit_info
        run: |
          COMMIT_MESSAGE="$(git log -1 --pretty=%B)"
          COMMIT_DATE="$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d %H:%M:%S')"

          echo "üìå Ïª§Î∞ã Î©îÏãúÏßÄ: $COMMIT_MESSAGE"
          echo "üìå Ïª§Î∞ã ÎÇ†Ïßú: $COMMIT_DATE"

          # Î¨∏Ï†ú ÌíÄÏù¥ Ïª§Î∞ãÏù∏ÏßÄ ÌôïÏù∏
          if echo "$COMMIT_MESSAGE" | grep -Eq "(\[.*\]) Title:|Time:.*Space:"; then
            echo "‚úÖ Î¨∏Ï†ú ÌíÄÏù¥ Ïª§Î∞ãÏûÖÎãàÎã§. Ï†ÑÏÜ°ÏùÑ ÏßÑÌñâÌï©ÎãàÎã§."
          else
            echo "‚ùå Î¨∏Ï†ú ÌíÄÏù¥ Ïª§Î∞ãÏù¥ ÏïÑÎãôÎãàÎã§. Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÏäµÎãàÎã§."
            echo "SKIP_WEBHOOK=true" >> $GITHUB_ENV
            exit 0
          fi

          # Î¨∏Ï†ú Ï†úÎ™© Î∞è Ï†ïÎ≥¥ Ï∂îÏ∂ú
          PROBLEM_TITLE=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*Title: \(.*\), Time:.*/\1/p' || echo "Unknown")
          PROBLEM_LEVEL=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*\[\(.*\)\].*/\1/p' || echo "N/A")
          TIME_INFO=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*Time: \([0-9.]* ms\).*/\1/p' || echo "N/A")
          MEMORY_INFO=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*Memory: \([0-9.]* [KM]B\|[0-9.]* MB\|[0-9.]* KB\).*/\1/p' || echo "N/A")

          # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "PROBLEM_TITLE=$PROBLEM_TITLE" >> $GITHUB_ENV
          echo "PROBLEM_LEVEL=$PROBLEM_LEVEL" >> $GITHUB_ENV
          echo "TIME_INFO=$TIME_INFO" >> $GITHUB_ENV
          echo "MEMORY_INFO=$MEMORY_INFO" >> $GITHUB_ENV

      - name: Send commit info to Discord
        if: ${{ env.SKIP_WEBHOOK != 'true' }}
        run: |
          JSON_DATA='{
            "content": "ÌíÄÏù¥ ÏãúÍ∞Å : '"${{ env.COMMIT_DATE }}"'",
            "embeds": [
              {
                "title": "Î¨∏Ï†ú Ï†ïÎ≥¥",
                "description": "**Ï†úÎ™©**: '"${{ env.PROBLEM_TITLE }}"'\n**ÎÇúÏù¥ÎèÑ**: '"${{ env.PROBLEM_LEVEL }}"'",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Ïã§Ìñâ ÏãúÍ∞Ñ",
                    "value": "'"${{ env.TIME_INFO }}"'",
                    "inline": true
                  },
                  {
                    "name": "Î©îÎ™®Î¶¨ ÏÇ¨Ïö©",
                    "value": "'"${{ env.MEMORY_INFO }}"'",
                    "inline": true
                  }
                ]
              }
            ]
          }'

          curl -H "Content-Type: application/json" -X POST -d "$JSON_DATA" "${{ secrets.DISCORD_WEBHOOK_URL }}"
